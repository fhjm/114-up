<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成績查詢與管理系統</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Chart.js (用於圖表) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 載入 Google Font (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 自定義樣式 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f8ff; /* 淡藍色背景 */
        }
        /* 基本動畫 */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* 隱藏滾動條但保留滾動功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* 登入卡片樣式 (仿造圖片) */
        .login-card {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 450px;
        }
        /* 身份選擇按鈕 */
        .role-btn {
            border: 2px solid #e5e7eb;
            color: #6b7280;
            transition: all 0.3s ease;
            font-size: 0.95rem; /* 調整字體大小以容納四個按鈕 */
        }
        .role-btn.active {
            border-color: #3b82f6; /* 藍色 */
            background-color: #eff6ff; /* 淡藍色 */
            color: #2563eb;
            font-weight: 600;
        }
        /* Custom modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-y: auto; /* 允許 modal 滾動 */
            padding: 2rem 0;
        }
        .modal-content {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            z-index: 50;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: auto; /* 確保在滾動時置中 */
        }
        
        /* 老師儀表板 Tab 樣式 */
        .dashboard-tab {
            padding: 0.75rem 1rem;
            border-bottom-width: 3px;
            border-color: transparent;
            font-size: 0.95rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }
        .dashboard-tab:hover {
            color: #374151;
            border-color: #d1d5db;
        }
        .dashboard-tab.active {
            color: #3b82f6;
            border-color: #3b82f6;
            font-weight: 600;
        }
        /* 表格排序標題樣式 */
        .th-sortable {
             padding: 0.75rem 1.5rem; 
             text-align: left; 
             font-size: 0.75rem; 
             font-weight: 500; 
             color: #6b7280; 
             text-transform: uppercase; 
             letter-spacing: 0.05em;
             cursor: pointer;
        }
        .th-sortable:hover {
            background-color: #f9fafb;
            color: #374151;
        }
    </style>
</head>
<body class="w-full min-h-screen flex items-center justify-center p-4">

    <!-- 應用程式容器 -->
    <div id="app" class="w-full">

        <!-- 登入頁面 (Login Page) -->
        <div id="login-page" class="w-full max-w-md mx-auto fade-in">
            <div class="login-card">
                <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">成績查詢與管理系統</h1>
                <p class="text-center text-gray-500 mb-8">請選擇您的身份</p>

                <!-- 身份選擇 (更新為 2x2) -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button id="role-admin-btn" class="role-btn flex items-center justify-center gap-2 py-3 px-4 rounded-xl">
                        管理員
                    </button>
                    <button id="role-homeroom-btn" class="role-btn flex items-center justify-center gap-2 py-3 px-4 rounded-xl">
                        導師
                    </button>
                    <button id="role-subject-btn" class="role-btn flex items-center justify-center gap-2 py-3 px-4 rounded-xl">
                        專科教師
                    </button>
                    <button id="role-student-btn" class="role-btn flex items-center justify-center gap-2 py-3 px-4 rounded-xl active">
                        學生
                    </button>
                </div>

                <!-- 登入表單 -->
                <form id="login-form">
                    <div class="mb-4">
                        <input id="name-input" type="text" placeholder="請輸入姓名" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                    </div>
                    <div class="mb-6">
                        <input id="pin-input" type="password" placeholder="請輸入 6 位數 PIN 碼" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required maxlength="6" pattern="\d{6}">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md transition-all duration-300 transform hover:scale-102">
                        登入系統
                    </button>
                    <!-- 設定按鈕 (已移除) -->
                </form>
            </div>
        </div>

        <!-- 管理員儀表板 (Admin Dashboard) -->
        <div id="admin-dashboard" class="hidden w-full max-w-7xl mx-auto fade-in">
            <header class="bg-white shadow-md rounded-xl p-6 mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-800">管理員系統</h1>
                    <p class="text-gray-600">歡迎，<span id="admin-name"></span>！</p>
                </div>
                <button id="admin-logout" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors">
                    登出
                </button>
            </header>
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-2xl font-semibold mb-6 text-gray-800">教師帳號管理</h3>
                <button id="add-teacher-btn" class="mb-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    + 新增教師
                </button>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PIN 碼</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">身份</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">負責科目</th>
                            </tr>
                        </thead>
                        <tbody id="teacher-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- 教師列表 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 導師儀表板 (Homeroom Dashboard) -->
        <div id="homeroom-dashboard" class="hidden w-full max-w-7xl mx-auto fade-in">
            <header class="bg-white shadow-md rounded-xl p-6 mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-800">導師管理系統</h1>
                    <p class="text-gray-600">歡迎，<span id="homeroom-name"></span>！</p>
                </div>
                <button id="homeroom-logout" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors">
                    登出
                </button>
            </header>
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-4 overflow-x-auto no-scrollbar" aria-label="Tabs">
                        <button class="dashboard-tab homeroom-tab active" data-tab="tab-account-manage">學生帳號管理</button>
                        <button class="dashboard-tab homeroom-tab" data-tab="tab-grade-entry">成績登錄</button>
                        <button class="dashboard-tab homeroom-tab" data-tab="tab-class-summary">班級段考總覽</button>
                        <button class="dashboard-tab homeroom-tab" data-tab="tab-student-summary">學生個別總覽</button>
                        <button class="dashboard-tab homeroom-tab" data-tab="tab-charts">班級統計圖表</button>
                    </nav>
                </div>
                <div id="homeroom-tab-content" class="min-h-[400px]">
                    <div id="tab-account-manage" class="homeroom-tab-panel">
                        <div class="flex items-center gap-4 mb-4">
                            <button id="add-student-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                + 新增學生
                            </button>
                            <button id="export-pin-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                匯出 PIN 碼 (CSV)
                            </button>
                        </div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">學生 PIN 碼總覽 (依座號排序)</h3>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">座號</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">學生姓名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">6 位數 PIN 碼</th>
                                    </tr>
                                </thead>
                                <tbody id="pin-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="tab-grade-entry" class="homeroom-tab-panel hidden">
                        <div class="mb-4">
                            <label for="exam-select-entry" class="text-lg font-medium text-gray-700">選擇段考：</label>
                            <select id="exam-select-entry" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="第一次段考">第一次段考</option>
                                <option value="第二次段考">第二次段考</option>
                                <option value="第三次段考">第三次段考</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">座號</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">學生姓名</th>
                                        <th class="th-subject">國文(x5)</th>
                                        <th class="th-subject">數學(x4)</th>
                                        <th class="th-subject">英文(x3)</th>
                                        <th class="th-subject">自然(x3)</th>
                                        <th class="th-subject">社會(x3)</th>
                                        <th class="th-subject">作文</th>
                                        <th class="th-subject">加權平均</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="grade-entry-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                            <style>.th-subject { padding: 0.75rem 1.5rem; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }</style>
                        </div>
                    </div>
                    <div id="tab-class-summary" class="homeroom-tab-panel hidden">
                        <div class="mb-4 flex items-center gap-4">
                            <div>
                                <label for="exam-select-summary" class="text-lg font-medium text-gray-700">選擇段考：</label>
                                <select id="exam-select-summary" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="第一次段考">第一次段考</option>
                                    <option value="第二次段考">第二次段考</option>
                                    <option value="第三次段考">第三次段考</option>
                                </select>
                            </div>
                            <button id="export-grades-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                匯出本次成績 (CSV)
                            </button>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="th-sortable" data-sort="seatNumber">座號</th>
                                        <th class="th-sortable" data-sort="name">學生姓名</th>
                                        <th class="th-sortable" data-sort="chinese">國文</th>
                                        <th class="th-sortable" data-sort="math">數學</th>
                                        <th class="th-sortable" data-sort="english">英文</th>
                                        <th class="th-sortable" data-sort="science">自然</th>
                                        <th class="th-sortable" data-sort="social">社會</th>
                                        <th class="th-sortable" data-sort="composition">作文</th>
                                        <th class="th-sortable" data-sort="weightedAvg">加權平均</th>
                                    </tr>
                                </thead>
                                <tbody id="class-summary-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="tab-student-summary" class="homeroom-tab-panel hidden">
                        <div class="mb-4">
                            <label for="student-select-summary" class="text-lg font-medium text-gray-700">選擇學生：</label>
                            <select id="student-select-summary" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                         <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">段考別</th>
                                        <th class="th-subject">國文</th>
                                        <th class="th-subject">數學</th>
                                        <th class="th-subject">英文</th>
                                        <th class="th-subject">自然</th>
                                        <th class="th-subject">社會</th>
                                        <th class="th-subject">作文</th>
                                        <th class="th-subject">加權平均</th>
                                    </tr>
                                </thead>
                                <tbody id="student-summary-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="tab-charts" class="homeroom-tab-panel hidden">
                        <div class="mb-4">
                            <label for="exam-select-charts" class="text-lg font-medium text-gray-700">選擇段考：</label>
                            <select id="exam-select-charts" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="第一次段考">第一次段考</option>
                                <option value="第二次段考">第二次段考</option>
                                <option value="第三次段考">第三次段考</option>
                            </select>
                        </div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">加權平均散佈圖</h3>
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <canvas id="scatter-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 專科教師儀表板 (Subject Teacher Dashboard) -->
        <div id="subject-teacher-dashboard" class="hidden w-full max-w-7xl mx-auto fade-in">
            <header class="bg-white shadow-md rounded-xl p-6 mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-800">專科教師系統</h1>
                    <p class="text-gray-600">歡迎，<span id="subject-teacher-name"></span>！ | 任教科目：<span id="subject-teacher-subject" class="font-semibold text-blue-700"></span></p>
                </div>
                <button id="subject-teacher-logout" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors">
                    登出
                </button>
            </header>
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-4 overflow-x-auto no-scrollbar" aria-label="Tabs">
                        <button class="dashboard-tab subject-teacher-tab active" data-tab="tab-subject-grade-entry">單科成績登錄</button>
                        <button class="dashboard-tab subject-teacher-tab" data-tab="tab-subject-class-summary">單科成績總覽</button>
                    </nav>
                </div>
                <div id="subject-teacher-tab-content" class="min-h-[400px]">
                    <div id="tab-subject-grade-entry" class="subject-teacher-tab-panel">
                        <div class="mb-4">
                            <label for="exam-select-subject-entry" class="text-lg font-medium text-gray-700">選擇段考：</label>
                            <select id="exam-select-subject-entry" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="第一次段考">第一次段考</option>
                                <option value="第二次段考">第二次段考</option>
                                <option value="第三次段考">第三次段考</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">座號</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">學生姓名</th>
                                        <th id="subject-entry-header" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">科目分數</th>
                                        <th id="subject-entry-header-2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="subject-grade-entry-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="tab-subject-class-summary" class="subject-teacher-tab-panel hidden">
                        <div class="mb-4">
                            <label for="exam-select-subject-summary" class="text-lg font-medium text-gray-700">選擇段考：</label>
                            <select id="exam-select-subject-summary" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="第一次段考">第一次段考</option>
                                <option value="第二次段考">第二次段考</option>
                                <option value="第三次段考">第三次段考</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="th-sortable" data-sort="seatNumber">座號</th>
                                        <th class="th-sortable" data-sort="name">學生姓名</th>
                                        <th id="subject-summary-header" class="th-sortable" data-sort="subjectScore">科目分數</th>
                                        <th id="subject-summary-header-2" class="th-sortable hidden" data-sort="composition">作文</th>
                                        <th class="th-sortable" data-sort="weightedAvg">加權平均</th>
                                    </tr>
                                </thead>
                                <tbody id="subject-class-summary-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 學生儀表板 (Student Dashboard) -->
        <div id="student-dashboard" class="hidden w-full max-w-7xl mx-auto fade-in">
            <header class="bg-white shadow-md rounded-xl p-6 mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-800">學生儀表板</h1>
                    <p class="text-gray-600">歡迎，<span id="student-name"></span>！ (座號: <span id="student-seat-number"></span>)</p>
                </div>
                <button id="student-logout" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors">
                    登出
                </button>
            </header>
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-4 overflow-x-auto no-scrollbar" aria-label="Tabs">
                        <button class="dashboard-tab student-tab active" data-tab="tab-student-dashboard">儀表板總覽</button>
                        <button class="dashboard-tab student-tab" data-tab="tab-subject-analysis">科目分析</button>
                        <button class="dashboard-tab student-tab" data-tab="tab-gemini-summary">AI 成績總結</button>
                    </nav>
                </div>
                <div id="student-tab-content" class="min-h-[400px]">
                    <div id="tab-student-dashboard" class="student-tab-panel">
                        <div class="mb-4">
                            <label for="exam-select-student" class="text-lg font-medium text-gray-700">選擇段考：</label>
                            <select id="exam-select-student" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-blue-50 p-6 rounded-xl shadow-sm">
                                <h4 class="text-sm font-medium text-blue-700 mb-2">加權平均</h4>
                                <p id="student-avg" class="text-4xl font-bold text-blue-900">--</p>
                            </div>
                            <div class="bg-blue-50 p-6 rounded-xl shadow-sm">
                                <h4 class="text-sm font-medium text-blue-700 mb-2">班級排名</h4>
                                <p id="student-rank" class="text-4xl font-bold text-blue-900">--</p>
                            </div>
                            <div class="bg-blue-50 p-6 rounded-xl shadow-sm">
                                <h4 class="text-sm font-medium text-blue-700 mb-2">總體平均 (所有段考)</h4>
                                <p id="student-overall-avg" class="text-4xl font-bold text-blue-900">--</p>
                            </div>
                        </div>
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">表現雷達圖 (v.s. 班級平均)</h3>
                        <div class="p-4 border rounded-lg bg-gray-50 max-w-2xl mx-auto">
                            <canvas id="radar-chart"></canvas>
                        </div>
                    </div>
                    <div id="tab-subject-analysis" class="student-tab-panel hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">各科班級排名 (選擇的段考)</h3>
                                <div class="overflow-x-auto rounded-lg border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">科目</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分數</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">排名</th>
                                            </tr>
                                        </thead>
                                        <tbody id="subject-rank-table" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">分數級距分佈</h3>
                                <div class="mb-4">
                                    <label for="subject-select-dist" class="text-sm font-medium text-gray-700">選擇科目：</label>
                                    <select id="subject-select-dist" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="chinese">國文</option>
                                        <option value="math">數學</option>
                                        <option value="english">英文</option>
                                        <option value="science">自然</option>
                                        <option value="social">社會</option>
                                        <option value="weightedAvg">加權平均</option>
                                    </select>
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <canvas id="dist-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-gemini-summary" class="student-tab-panel hidden">
                        <button id="get-gemini-summary-btn" class="mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            取得 AI 學習建議 (基於本次段考)
                        </button>
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Gemini 學習建議</h3>
                        <div id="gemini-loading" class="hidden text-center p-4">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                            <p class="mt-2 text-gray-600">AI 正在分析您的成績，請稍候...</p>
                        </div>
                        <div id="gemini-summary-content" class="p-6 border rounded-lg bg-gray-50 text-gray-700 leading-relaxed min-h-[150px]">
                            <p class="text-gray-500">請點擊按鈕以生成基於您最新段考成績的學習建議。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入中畫面 (Loading Overlay) -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-24 w-24 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- 自定義提示 Modal (Custom Alert Modal) -->
    <div id="alert-modal" class="hidden modal-backdrop">
        <div class="modal-content fade-in">
            <h3 id="alert-title" class="text-xl font-bold text-red-600 mb-4">錯誤</h3>
            <p id="alert-message" class="text-gray-700 mb-6"></p>
            <button id="alert-close-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                關閉
            </button>
        </div>
    </div>

    <!-- (導師用) 學生帳號 Modal (Add Student Modal) -->
    <div id="add-student-modal" class="hidden modal-backdrop">
        <div class="modal-content fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">新增學生帳號</h3>
            <form id="add-student-form">
                <div class="mb-4">
                    <label for="new-student-name" class="block text-sm font-medium text-gray-700 mb-1">學生姓名</label>
                    <input id="new-student-name" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                </div>
                <!-- 新增座號欄位 -->
                <div class="mb-4">
                    <label for="new-student-seat-number" class="block text-sm font-medium text-gray-700 mb-1">學生座號</label>
                    <input id="new-student-seat-number" type="number" min="1" max="99" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                </div>
                <p class="text-sm text-gray-500 mb-6">系統將自動生成一組 6 位數 PIN 碼。</p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-student" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">確認新增</button>
                </div>
            </form>
        </div>
    </div>

    <!-- (管理員用) 教師帳號 Modal (Add Teacher Modal) -->
    <div id="add-teacher-modal" class="hidden modal-backdrop">
        <div class="modal-content fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">新增教師帳號</h3>
            <form id="add-teacher-form">
                <div class="mb-4">
                    <label for="new-teacher-name" class="block text-sm font-medium text-gray-700 mb-1">教師姓名</label>
                    <input id="new-teacher-name" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                </div>
                <div class="mb-4">
                    <label for="new-teacher-role" class="block text-sm font-medium text-gray-700 mb-1">教師身份</label>
                    <select id="new-teacher-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                        <option value="homeroom">導師</option>
                        <option value="subject">專科教師</option>
                    </select>
                </div>
                <div id="subject-field" class="mb-4 hidden">
                    <label for="new-teacher-subject" class="block text-sm font-medium text-gray-700 mb-1">負責科目</label>
                    <select id="new-teacher-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="chinese">國文 (包含作文)</option>
                        <option value="math">數學</option>
                        <option value="english">英文</option>
                        <option value="science">自然</option>
                        <option value="social">社會</option>
                        <!-- 移除 作文 選項 -->
                    </select>
                </div>
                <p class="text-sm text-gray-500 mb-6">系統將自動生成一組 6 位數 PIN 碼。</p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-teacher" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">確認新增</button>
                </div>
            </form>
        </div>
    </div>

    <!-- (導師用) 全科成績編輯 Modal (Edit Grade Modal) -->
    <div id="edit-grade-modal" class="hidden modal-backdrop no-scrollbar overflow-y-auto">
        <div class="modal-content fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">編輯成績</h3>
            <p class="text-gray-600 mb-6">學生: <span id="modal-student-name" class="font-semibold"></span> | 段考: <span id="modal-exam-name" class="font-semibold"></span></p>
            <form id="edit-grade-form">
                <input type="hidden" id="modal-student-id">
                <input type="hidden" id="modal-exam-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="modal-chinese" class="block text-sm font-medium text-gray-700">國文 (x5)</label>
                        <input type="number" id="modal-chinese" class="modal-score-input" min="0" max="100" step="0.1">
                    </div>
                    <div>
                        <label for="modal-math" class="block text-sm font-medium text-gray-700">數學 (x4)</label>
                        <input type="number" id="modal-math" class="modal-score-input" min="0" max="100" step="0.1">
                    </div>
                    <div>
                        <label for="modal-english" class="block text-sm font-medium text-gray-700">英文 (x3)</label>
                        <input type="number" id="modal-english" class="modal-score-input" min="0" max="100" step="0.1">
                    </div>
                    <div>
                        <label for="modal-science" class="block text-sm font-medium text-gray-700">自然 (x3)</label>
                        <input type="number" id="modal-science" class="modal-score-input" min="0" max="100" step="0.1">
                    </div>
                    <div>
                        <label for="modal-social" class="block text-sm font-medium text-gray-700">社會 (x3)</label>
                        <input type="number" id="modal-social" class="modal-score-input" min="0" max="100" step="0.1">
                    </div>
                    <div>
                        <label for="modal-composition" class="block text-sm font-medium text-gray-700">作文 (不計)</label>
                        <input type="number" id="modal-composition" class="modal-score-input" min="0" max="100" step="0.1">
                    </div>
                </div>
                <style>
                    .modal-score-input {
                        width: 100%; 
                        padding: 8px 12px; 
                        border: 1px solid #D1D5DB; 
                        border-radius: 0.5rem; 
                        margin-top: 4px;
                    }
                </style>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-grade" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- (專科教師用) 單科成績編輯 Modal (Edit Subject Grade Modal) -->
    <div id="edit-subject-grade-modal" class="hidden modal-backdrop">
        <div class="modal-content fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">編輯單科成績</h3>
            <p class="text-gray-600 mb-6">學生: <span id="modal-subject-student-name" class="font-semibold"></span> | 段考: <span id="modal-subject-exam-name" class="font-semibold"></span></p>
            <form id="edit-subject-grade-form">
                <input type="hidden" id="modal-subject-student-id">
                <input type="hidden" id="modal-subject-exam-id">
                
                <!-- 單科 (預設) -->
                <div id="modal-subject-field" class="mb-4">
                    <label id="modal-subject-label" for="modal-subject-score-main" class="block text-sm font-medium text-gray-700 mb-1">科目分數</label>
                    <input type="number" id="modal-subject-score-main" class="modal-score-input" min="0" max="100" step="0.1">
                </div>
                
                <!-- 作文 (國文老師專用) -->
                <div id="modal-composition-field" class="hidden mb-4">
                    <label for="modal-subject-score-composition" class="block text-sm font-medium text-gray-700 mb-1">作文 分數</label>
                    <input type="number" id="modal-subject-score-composition" class="modal-score-input" min="0" max="100" step="0.1">
                </div>

                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-subject-grade" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <!-- (部署用) 設定 Modal (已移除) -->


    <!-- Firebase SDK (ESM - 模組) -->
    <script type="module">
        // 匯入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            collection, 
            query, 
            where, 
            getDocs,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全域變數 ---
        let db, auth, currentUserId;
        let selectedRole = 'student'; // 預設身份
        let currentUser = null; // 登入後的使用者物件 { name, pin, role, subject? }
        let allStudents = []; // 導師/專科教師用：緩存所有學生
        let allGrades = []; // 緩存查詢的成績 (已包含學生資料)
        
        // 圖表實例
        let radarChartInstance = null;
        let scatterChartInstance = null;
        let distChartInstance = null;

        // 科目權重
        const weights = { chinese: 5, math: 4, english: 3, science: 3, social: 3 };
        const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
        const subjects = ['chinese', 'math', 'english', 'science', 'social'];
        const subjectNames = {
            seatNumber: '座號',
            name: '姓名',
            chinese: '國文',
            math: '數學',
            english: '英文',
            science: '自然',
            social: '社會',
            composition: '作文',
            weightedAvg: '加權平均'
        };

        // --- UI 元素 (擷取) ---
        const loginPage = document.getElementById('login-page');
        const adminDashboard = document.getElementById('admin-dashboard');
        const homeroomDashboard = document.getElementById('homeroom-dashboard');
        const subjectTeacherDashboard = document.getElementById('subject-teacher-dashboard');
        const studentDashboard = document.getElementById('student-dashboard');
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const alertModal = document.getElementById('alert-modal');
        const addStudentModal = document.getElementById('add-student-modal');
        const addTeacherModal = document.getElementById('add-teacher-modal');
        const editGradeModal = document.getElementById('edit-grade-modal');
        const editSubjectGradeModal = document.getElementById('edit-subject-grade-modal');
        // const settingsModal = document.getElementById('settings-modal'); // 已移除

        // --- 部署用：設定相關 (金鑰請貼在此處) ---
            
        // ▼▼▼▼▼ 請在此處貼上您的 Firebase 設定 ▼▼▼▼▼
        // (請將 "..." 替換成您從 Firebase 控制台複製的 JSON 物件)
        const firebaseConfig = {
            apiKey: "AIzaSyCsZBXs8-nDan47tQIzseRtlRGf284RXTw",
            authDomain: "ymjh1141.firebaseapp.com",
            projectId: "ymjh1141",
            storageBucket: "ymjh1141.firebasestorage.app",
            messagingSenderId: "142499425515",
            appId: "1:142499425515:web:4c296d7e7df16cb656e2ae"
        };
        // ▲▲▲▲▲ 請在此處貼上您的 Firebase 設定 ▲▲▲▲▲
        
        // ▼▼▼▼▼ 請在此處貼上您的 Gemini API Key ▼▼▼▼▼
        // (請將 "..." 替換成您的 Gemini API 金鑰字串)
        const GEMINI_API_KEY = "AIzaSyBG58Qf1zfsFeScteagFXSi-h21C7vxabg";
        // ▲▲▲▲▲ 請在此處貼上您的 Gemini API Key ▲▲▲▲▲


        // --- Firebase 初始化 (部署版) ---

        function initializeFirebase(config) {
            try {
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                console.log("Firebase 初始化成功");

                // 監聽認證狀態
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Firebase 已認證 (匿名)，UID:", user.uid);
                        currentUserId = user.uid;
                        // 檢查並建立預設帳號 (僅在匿名登入成功後)
                        await checkAndCreateDefaultUsers();
                    } else {
                        console.log("Firebase 未認證，嘗試匿名登入...");
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase 匿名登入失敗:", error);
                            showAlert("認證失敗", "無法登入系統，請檢查您的網路連線或 Firebase 設定。");
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                showAlert("系統錯誤", "無法初始化 Firebase。請檢查您的 Firebase 設定。");
            }
        }
        
        // 程式啟動時直接初始化
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY") {
            showAlert("設定錯誤", "Firebase 設定不完整。請在 HTML 檔案的 <script> 標籤中填入您的 Firebase 設定。");
        } else {
            initializeFirebase(firebaseConfig);
        }


        // 檢查並建立預設帳號 (管理員 + 導師)
        async function checkAndCreateDefaultUsers() {
            if (!db) return;
            // *** 路徑簡化 ***
            const usersCol = collection(db, "users");
            
            const defaultAdmin = { name: "管理員", pin: "000000", role: "admin" };
            const defaultHomeroom = { name: "導師", pin: "111111", role: "homeroom" };
            
            try {
                // 檢查管理員
                const adminRef = doc(usersCol, defaultAdmin.name);
                const adminSnap = await getDoc(adminRef);
                if (!adminSnap.exists()) {
                    await setDoc(adminRef, defaultAdmin);
                    console.log("預設 '管理員' 帳號建立成功 (PIN: 000000)");
                }
                
                // 檢查預設導師
                const homeroomRef = doc(usersCol, defaultHomeroom.name);
                const homeroomSnap = await getDoc(homeroomRef);
                if (!homeroomSnap.exists()) {
                    await setDoc(homeroomRef, defaultHomeroom);
                    console.log("預設 '導師' 帳號建立成功 (PIN: 111111)");
                }
            } catch (error) {
                console.error("檢查預設帳號時發生錯誤:", error);
                // 可能是權限問題
                showAlert("Firestore 錯誤", "無法讀寫 'users' 集合。請檢查您的 Firestore 安全規則。");
            }
        }


        // --- 輔助函式 ---
        function showView(viewId) {
            loginPage.classList.toggle('hidden', viewId !== 'login');
            adminDashboard.classList.toggle('hidden', viewId !== 'admin');
            homeroomDashboard.classList.toggle('hidden', viewId !== 'homeroom');
            subjectTeacherDashboard.classList.toggle('hidden', viewId !== 'subject');
            studentDashboard.classList.toggle('hidden', viewId !== 'student');
        }

        function showLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }

        function showAlert(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            alertModal.classList.remove('hidden');
        }

        // 計算加權平均
        function calculateWeightedAverage(scores) {
            let totalScore = 0;
            for (const subject of subjects) {
                totalScore += (parseFloat(scores[subject]) || 0) * weights[subject];
            }
            const avg = (totalScore / totalWeight);
            return isNaN(avg) ? '0.00' : avg.toFixed(2);
        }

        // 產生 6 位數 PIN 碼
        function generatePIN() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // --- CSV 相關函式 (NEW) ---
        function downloadCSV(csvContent, fileName) {
            // 加入 BOM 讓 Excel 正常讀取 UTF-8
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 匯出 PIN 碼
        function exportPinCSV() {
            if (allStudents.length === 0) {
                showAlert("提示", "沒有學生資料可匯出。");
                return;
            }
            let csvContent = "座號,學生姓名,PIN碼\n";
            // 確保是依照座號排序的
            const sortedStudents = [...allStudents].sort((a, b) => (a.seatNumber || 999) - (b.seatNumber || 999));
            
            sortedStudents.forEach(student => {
                csvContent += `${student.seatNumber || ''},${student.name},${student.pin}\n`;
            });
            
            downloadCSV(csvContent, '學生PIN碼清單.csv');
        }
        
        // 匯出成績
        function exportGradesCSV() {
            if (allGrades.length === 0) {
                showAlert("提示", "沒有成績資料可匯出。");
                return;
            }
            const selectedExam = document.getElementById('exam-select-summary').value;
            let csvContent = "座號,學生姓名,國文,數學,英文,自然,社會,作文,加權平均\n";
            
            // 確保是依照座號排序的
            const sortedGrades = [...allGrades].sort((a, b) => (a.seatNumber || 999) - (b.seatNumber || 999));
            
            sortedGrades.forEach(grade => {
                csvContent += [
                    grade.seatNumber || '',
                    grade.studentName,
                    grade.chinese || 0,
                    grade.math || 0,
                    grade.english || 0,
                    grade.science || 0,
                    grade.social || 0,
                    grade.composition || 0,
                    grade.weightedAvg || 0
                ].join(',') + '\n';
            });
            
            downloadCSV(csvContent, `${selectedExam}_班級成績.csv`);
        }
        
        // --- 事件監聽 (Event Listeners) ---
        
        // 身份選擇
        const roleButtons = {
            'admin': document.getElementById('role-admin-btn'),
            'homeroom': document.getElementById('role-homeroom-btn'),
            'subject': document.getElementById('role-subject-btn'),
            'student': document.getElementById('role-student-btn')
        };
        const pinInput = document.getElementById('pin-input');

        Object.keys(roleButtons).forEach(role => {
            roleButtons[role].addEventListener('click', () => {
                selectedRole = role;
                Object.values(roleButtons).forEach(btn => btn.classList.remove('active'));
                roleButtons[role].classList.add('active');
                
                switch(role) {
                    case 'admin':
                        pinInput.placeholder = "請輸入管理員 PIN 碼"; break;
                    case 'homeroom':
                        pinInput.placeholder = "請輸入導師 PIN 碼"; break;
                    case 'subject':
                        pinInput.placeholder = "請輸入專科教師 PIN 碼"; break;
                    case 'student':
                        pinInput.placeholder = "請輸入學生 6 位數 PIN 碼"; break;
                }
            });
        });

        // 登出
        document.getElementById('admin-logout').addEventListener('click', logout);
        document.getElementById('homeroom-logout').addEventListener('click', logout);
        document.getElementById('subject-teacher-logout').addEventListener('click', logout);
        document.getElementById('student-logout').addEventListener('click', logout);

        function logout() {
            currentUser = null;
            allStudents = [];
            allGrades = [];
            document.getElementById('name-input').value = '';
            document.getElementById('pin-input').value = '';
            showView('login');
        }

        // 關閉 Modal
        document.getElementById('alert-close-btn').addEventListener('click', () => alertModal.classList.add('hidden'));
        document.getElementById('cancel-add-student').addEventListener('click', () => addStudentModal.classList.add('hidden'));
        document.getElementById('cancel-add-teacher').addEventListener('click', () => addTeacherModal.classList.add('hidden'));
        document.getElementById('cancel-edit-grade').addEventListener('click', () => editGradeModal.classList.add('hidden'));
        document.getElementById('cancel-edit-subject-grade').addEventListener('click', () => editSubjectGradeModal.classList.add('hidden'));

        // --- 登入邏輯 (已更新) ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db) {
                showAlert("系統錯誤", "資料庫未連接。請在 HTML 檔案的 <script> 標籤中填入您的 Firebase 設定。");
                return;
            }

            const name = document.getElementById('name-input').value.trim();
            const pin = document.getElementById('pin-input').value.trim();

            if (!name || !pin) {
                showAlert("登入失敗", "請輸入姓名和 PIN 碼。");
                return;
            }

            showLoading(true);
            try {
                // *** 路徑簡化 ***
                const usersCol = collection(db, "users");
                const q = query(usersCol, where("name", "==", name), where("pin", "==", pin));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showAlert("登入失敗", "姓名或 PIN 碼錯誤。");
                } else {
                    const userDoc = querySnapshot.docs[0].data();
                    
                    // 檢查選擇的身份是否與資料庫中的身份相符
                    if (userDoc.role !== selectedRole) {
                        showAlert("登入失敗", "您的身份選擇與帳號不符。");
                        showLoading(false);
                        return;
                    }

                    currentUser = userDoc; // { name, pin, role, subject?, seatNumber? }

                    // 根據身份導向不同的儀表板
                    switch (userDoc.role) {
                        case 'admin':
                            document.getElementById('admin-name').textContent = userDoc.name;
                            await loadAdminDashboard();
                            showView('admin');
                            break;
                        case 'homeroom':
                            document.getElementById('homeroom-name').textContent = userDoc.name;
                            await loadHomeroomDashboard();
                            showView('homeroom');
                            break;
                        case 'subject':
                            document.getElementById('subject-teacher-name').textContent = userDoc.name;
                            const subjectName = subjectNames[userDoc.subject] || userDoc.subject;
                            document.getElementById('subject-teacher-subject').textContent = subjectName;
                            await loadSubjectTeacherDashboard();
                            showView('subject');
                            break;
                        case 'student':
                            document.getElementById('student-name').textContent = userDoc.name;
                            document.getElementById('student-seat-number').textContent = userDoc.seatNumber || 'N/A';
                            await loadStudentDashboard();
                            showView('student');
                            break;
                        default:
                            showAlert("系統錯誤", "未知的用戶身份。");
                    }
                }
            } catch (error) {
                console.error("登入時發生錯誤:", error);
                showAlert("系統錯誤", `登入失敗：${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // --- 管理員儀表板 (Admin Dashboard) ---
        
        // 載入管理員儀表板 (教師列表)
        async function loadAdminDashboard() {
            showLoading(true);
            const tableBody = document.getElementById('teacher-table-body');
            tableBody.innerHTML = '';
            
            try {
                // *** 路徑簡化 ***
                const usersCol = collection(db, "users");
                // 查詢所有 'homeroom' 或 'subject' 的使用者
                const q = query(usersCol, where("role", "in", ["homeroom", "subject"]));
                const querySnapshot = await getDocs(q);
                
                let teachers = [];
                querySnapshot.forEach(doc => teachers.push(doc.data()));
                
                // 排序
                teachers.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
                
                teachers.forEach(teacher => {
                    const tr = document.createElement('tr');
                    const roleName = teacher.role === 'homeroom' ? '導師' : '專科教師';
                    const subjectName = teacher.subject ? (subjectNames[teacher.subject] || teacher.subject) : '--';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${teacher.pin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${roleName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${subjectName}</td>
                    `;
                    tableBody.appendChild(tr);
                });

            } catch (error) {
                console.error("載入教師列表失敗:", error);
                showAlert("系統錯誤", `載入教師列表失敗：${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        // "新增教師" 按鈕
        document.getElementById('add-teacher-btn').addEventListener('click', () => {
            document.getElementById('add-teacher-form').reset();
            document.getElementById('subject-field').classList.add('hidden'); // 預設隱藏
            addTeacherModal.classList.remove('hidden');
        });
        
        // 監聽 "教師身份" 下拉選單
        document.getElementById('new-teacher-role').addEventListener('change', (e) => {
            const subjectField = document.getElementById('subject-field');
            if (e.target.value === 'subject') {
                subjectField.classList.remove('hidden'); // 顯示科目選擇
            } else {
                subjectField.classList.add('hidden'); // 隱藏
            }
        });

        // "新增教師" 表單提交
        document.getElementById('add-teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = document.getElementById('new-teacher-name').value.trim();
            const newRole = document.getElementById('new-teacher-role').value;
            const newSubject = document.getElementById('new-teacher-subject').value;
            
            if (!newName) {
                showAlert("錯誤", "教師姓名不能為空白。");
                return;
            }
            
            const newPin = generatePIN();
            showLoading(true);
            
            const newTeacherData = {
                name: newName,
                pin: newPin,
                role: newRole
            };
            
            if (newRole === 'subject') {
                newTeacherData.subject = newSubject;
            }

            try {
                // *** 路徑簡化 ***
                const userRef = doc(db, "users", newName);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    showAlert("錯誤", "該教師姓名已存在。");
                    showLoading(false);
                    return;
                }

                // 新增教師
                await setDoc(userRef, newTeacherData);
                addTeacherModal.classList.add('hidden');
                await loadAdminDashboard(); // 重新整理列表
                
            } catch (error) {
                console.error("新增教師失敗:", error);
                showAlert("系統錯誤", `新增教師失敗：${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // --- 導師儀表板 (Homeroom Dashboard) ---

        async function loadHomeroomDashboard() {
            // 預設載入第一個 tab
            await loadHomeroomAccountManageTab();
            setupHomeroomTabs();
        }
        
        function setupHomeroomTabs() {
            const tabs = document.querySelectorAll('.homeroom-tab');
            const panels = document.querySelectorAll('.homeroom-tab-panel');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', async () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    panels.forEach(p => p.classList.add('hidden'));
                    const targetTab = tab.getAttribute('data-tab');
                    document.getElementById(targetTab).classList.remove('hidden');

                    switch (targetTab) {
                        case 'tab-account-manage': await loadHomeroomAccountManageTab(); break;
                        case 'tab-grade-entry': await loadHomeroomGradeEntryTab(); break;
                        case 'tab-class-summary': await loadHomeroomClassSummaryTab(); break;
                        case 'tab-student-summary': await loadHomeroomStudentSummaryTab(); break;
                        case 'tab-charts': await loadHomeroomChartsTab(); break;
                    }
                });
            });

            // 導師端：事件監聽
            document.getElementById('exam-select-entry').addEventListener('change', loadHomeroomGradeEntryTab);
            document.getElementById('exam-select-summary').addEventListener('change', loadHomeroomClassSummaryTab);
            document.getElementById('student-select-summary').addEventListener('change', loadHomeroomStudentSummaryTab_Grades);
            document.getElementById('exam-select-charts').addEventListener('change', loadHomeroomChartsTab);
            
            // CSV 匯出按鈕
            document.getElementById('export-pin-csv-btn').addEventListener('click', exportPinCSV);
            document.getElementById('export-grades-csv-btn').addEventListener('click', exportGradesCSV);
        }

        // 獲取所有學生 (導師和專科教師共用) (依座號排序)
        async function getAllStudents() {
            if (allStudents.length > 0) {
                return allStudents; // 返回緩存
            }
            
            // *** 路徑簡化 ***
            const usersCol = collection(db, "users");
            const q = query(usersCol, where("role", "==", "student"));
            const querySnapshot = await getDocs(q);
            
            let students = [];
            querySnapshot.forEach(doc => students.push(doc.data()));
            // 預設依座號排序
            students.sort((a, b) => (a.seatNumber || 999) - (b.seatNumber || 999));
            allStudents = students;
            return allStudents;
        }

        // Tab 1: 學生帳號管理 (導師)
        document.getElementById('add-student-btn').addEventListener('click', () => {
            document.getElementById('add-student-form').reset();
            addStudentModal.classList.remove('hidden');
        });

        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = document.getElementById('new-student-name').value.trim();
            const newSeatNumber = document.getElementById('new-student-seat-number').value;

            if (!newName || !newSeatNumber) {
                showAlert("錯誤", "學生姓名和座號皆為必填。");
                return;
            }

            const newPin = generatePIN();
            showLoading(true);

            try {
                // *** 路徑簡化 ***
                const userRef = doc(db, "users", newName);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    showAlert("錯誤", "該用戶姓名已存在 (可能是學生或教師)。");
                    showLoading(false);
                    return;
                }
                
                // 檢查座號是否重複
                // *** 路徑簡化 ***
                const q = query(collection(db, "users"), where("role", "==", "student"), where("seatNumber", "==", parseInt(newSeatNumber)));
                const seatSnap = await getDocs(q);
                if (!seatSnap.empty) {
                     showAlert("錯誤", "該座號已被使用。");
                     showLoading(false);
                     return;
                }

                // 新增學生 (role: student)
                await setDoc(userRef, {
                    name: newName,
                    pin: newPin,
                    role: "student",
                    seatNumber: parseInt(newSeatNumber)
                });

                addStudentModal.classList.add('hidden');
                allStudents = []; // 清空學生緩存
                await loadHomeroomAccountManageTab(); // 重新整理列表
            } catch (error) {
                console.error("新增學生失敗:", error);
                showAlert("系統錯誤", `新增學生失敗：${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        async function loadHomeroomAccountManageTab() {
            showLoading(true);
            try {
                const students = await getAllStudents(); // 已依座號排序
                const pinTableBody = document.getElementById('pin-table-body');
                pinTableBody.innerHTML = '';
                
                students.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${student.seatNumber || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.pin}</td>
                    `;
                    pinTableBody.appendChild(tr);
                });
                
                // 更新其他下拉選單
                updateStudentSelects(students);

            } catch (error) {
                console.error("載入學生列表失敗:", error);
            } finally {
                showLoading(false);
            }
        }
        
        function updateStudentSelects(students) {
             const studentSelect = document.getElementById('student-select-summary');
             studentSelect.innerHTML = '<option value="">請選擇學生</option>';
             students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.name;
                option.textContent = `${student.seatNumber || ''}. ${student.name}`; // 下拉選單也顯示座號
                studentSelect.appendChild(option);
             });
        }

        // Tab 2: 成績登錄 (導師)
        async function loadHomeroomGradeEntryTab() {
            const selectedExam = document.getElementById('exam-select-entry').value;
            const tableBody = document.getElementById('grade-entry-table-body');
            tableBody.innerHTML = '';
            
            showLoading(true);
            try {
                const students = await getAllStudents(); // 已依座號排序
                const gradesMap = await getGradesForExam(selectedExam);

                // 顯示所有學生
                students.forEach(student => {
                    const grade = gradesMap.get(student.name) || {};
                    const weightedAvg = grade.weightedAvg || '--';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${student.seatNumber || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.chinese || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.math || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.english || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.science || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.social || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.composition || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${parseFloat(weightedAvg) >= 60 ? 'text-blue-600' : (weightedAvg === '--' ? 'text-gray-500' : 'text-red-600')}">${weightedAvg}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="edit-grade-btn text-blue-600 hover:text-blue-900" data-student-name="${student.name}">編輯</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
                
                // 綁定編輯按鈕事件
                document.querySelectorAll('.edit-grade-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const studentName = btn.getAttribute('data-student-name');
                        const grade = gradesMap.get(studentName) || {};
                        openEditGradeModal(studentName, selectedExam, grade);
                    });
                });

            } catch (error) {
                console.error("載入成績登錄列表失敗:", error);
            } finally {
                showLoading(false);
            }
        }
        
        // (共用) 獲取某次段考的所有成績
        async function getGradesForExam(exam) {
            // *** 路徑簡化 ***
            const gradesCol = collection(db, "grades");
            const q = query(gradesCol, where("exam", "==", exam));
            const gradeSnapshot = await getDocs(q);
            
            const gradesMap = new Map();
            gradeSnapshot.forEach(doc => {
                gradesMap.set(doc.data().studentName, doc.data());
            });
            return gradesMap;
        }
        
        // 開啟全科成績編輯 Modal (導師)
        function openEditGradeModal(studentName, exam, grade) {
            document.getElementById('modal-student-name').textContent = studentName;
            document.getElementById('modal-exam-name').textContent = exam;
            document.getElementById('modal-student-id').value = studentName;
            document.getElementById('modal-exam-id').value = exam;
            
            document.getElementById('modal-chinese').value = grade.chinese || '';
            document.getElementById('modal-math').value = grade.math || '';
            document.getElementById('modal-english').value = grade.english || '';
            document.getElementById('modal-science').value = grade.science || '';
            document.getElementById('modal-social').value = grade.social || '';
            document.getElementById('modal-composition').value = grade.composition || '';
            
            editGradeModal.classList.remove('hidden');
        }

        // 儲存全科成績 (導師)
        document.getElementById('edit-grade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentName = document.getElementById('modal-student-id').value;
            const exam = document.getElementById('modal-exam-id').value;
            
            const scores = {
                chinese: parseFloat(document.getElementById('modal-chinese').value) || 0,
                math: parseFloat(document.getElementById('modal-math').value) || 0,
                english: parseFloat(document.getElementById('modal-english').value) || 0,
                science: parseFloat(document.getElementById('modal-science').value) || 0,
                social: parseFloat(document.getElementById('modal-social').value) || 0,
                composition: parseFloat(document.getElementById('modal-composition').value) || 0,
            };
            
            const weightedAvg = calculateWeightedAverage(scores);
            
            const gradeData = {
                studentName,
                exam,
                ...scores,
                weightedAvg
            };
            
            showLoading(true);
            try {
                const docId = `${studentName}_${exam}`;
                // *** 路徑簡化 ***
                // 使用 setDoc 搭配 { merge: true } 來更新或建立，避免覆蓋其他專科老師的成績
                await setDoc(doc(db, "grades", docId), gradeData, { merge: true });
                
                editGradeModal.classList.add('hidden');
                await loadHomeroomGradeEntryTab(); // 重新載入
                
            } catch (error) {
                console.error("儲存成績失敗:", error);
                showAlert("系統錯誤", `儲存成績失敗：${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // Tab 3: 班級段考總覽 (導師)
        async function loadHomeroomClassSummaryTab() {
            const selectedExam = document.getElementById('exam-select-summary').value;
            showLoading(true);

            try {
                // 1. 獲取所有學生 (含座號)
                const students = await getAllStudents();
                // 2. 獲取該次段考成績
                const gradesMap = await getGradesForExam(selectedExam);
                
                // 3. 合併資料
                const mergedData = students.map(student => {
                    const grade = gradesMap.get(student.name) || {};
                    return {
                        ...student, // name, seatNumber, pin, role
                        ...grade, // 包含各科成績
                        studentName: student.name // 確保 studentName 存在
                    };
                });
                
                // 預設依加權平均排序
                mergedData.sort((a, b) => (b.weightedAvg || 0) - (a.weightedAvg || 0));
                
                allGrades = mergedData; // 緩存此次查詢
                renderClassSummaryTable(mergedData);
                
            } catch (error) {
                console.error("載入班級總覽失敗:", error);
            } finally {
                showLoading(false);
            }
        }
        
        function renderClassSummaryTable(grades) {
            const tableBody = document.getElementById('class-summary-table-body');
            tableBody.innerHTML = '';
            grades.forEach(grade => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${grade.seatNumber || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${grade.studentName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.chinese || '--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.math || '--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.english || '--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.science || '--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.social || '--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.composition || '--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${parseFloat(grade.weightedAvg) >= 60 ? 'text-blue-600' : 'text-red-600'}">${grade.weightedAvg || '--'}</td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        // Tab 4: 學生個別總覽 (導師)
        async function loadHomeroomStudentSummaryTab() {
            if (allStudents.length === 0) {
                await loadHomeroomAccountManageTab(); // 確保學生下拉選單已載入
            }
            loadHomeroomStudentSummaryTab_Grades(); // 載入成績
        }
        
        async function loadHomeroomStudentSummaryTab_Grades() {
            const studentName = document.getElementById('student-select-summary').value;
            const tableBody = document.getElementById('student-summary-table-body');
            tableBody.innerHTML = '';
            
            if (!studentName) return;
            
            showLoading(true);
            try {
                // *** 路徑簡化 ***
                const gradesCol = collection(db, "grades");
                const q = query(gradesCol, where("studentName", "==", studentName));
                const gradeSnapshot = await getDocs(q);
                
                const grades = {};
                gradeSnapshot.forEach(doc => {
                    const data = doc.data();
                    grades[data.exam] = data;
                });
                
                ['第一次段考', '第二次段考', '第三次段考'].forEach(exam => {
                    const grade = grades[exam];
                    const tr = document.createElement('tr');
                    if(grade) {
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${exam}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.chinese || '--'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.math || '--'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.english || '--'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.science || '--'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.social || '--'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${grade.composition || '--'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${parseFloat(grade.weightedAvg) >= 60 ? 'text-blue-600' : 'text-red-600'}">${grade.weightedAvg || '--'}</td>
                        `;
                    } else {
                         tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${exam}</td>
                            <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-center">尚未登錄成績</td>
                        `;
                    }
                    tableBody.appendChild(tr);
                });
                
            } catch (error) {
                console.error("載入學生個別總覽失敗:", error);
            } finally {
                showLoading(false);
            }
        }
        
        // Tab 5: 班級統計圖表 (導師)
        async function loadHomeroomChartsTab() {
            const selectedExam = document.getElementById('exam-select-charts').value;
            showLoading(true);

            try {
                const gradesMap = await getGradesForExam(selectedExam);
                const scatterData = [];
                gradesMap.forEach(grade => {
                    if (grade.weightedAvg) { // 只顯示有平均的
                        scatterData.push({
                            x: grade.weightedAvg,
                            y: Math.random() * 10,
                            label: grade.studentName
                        });
                    }
                });
                renderScatterChart(scatterData);
            } catch (error) {
                console.error("載入散佈圖失敗:", error);
            } finally {
                showLoading(false);
            }
        }
        
        function renderScatterChart(data) {
            const ctx = document.getElementById('scatter-chart').getContext('2d');
            if (scatterChartInstance) scatterChartInstance.destroy();
            scatterChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: { datasets: [{ label: '加權平均散佈', data: data, backgroundColor: 'rgba(59, 130, 246, 0.6)' }] },
                options: {
                    responsive: true,
                    scales: { x: { title: { display: true, text: '加權平均分數' }, min: 0, max: 100 }, y: { display: false } },
                    plugins: { tooltip: { callbacks: { label: (context) => `${context.raw.label}: ${context.raw.x}` } } }
                }
            });
        }

        // --- 專科教師儀表板 (Subject Teacher Dashboard) ---
        
        async function loadSubjectTeacherDashboard() {
            const subjectKey = currentUser.subject;
            const subjectName = subjectNames[subjectKey] || subjectKey;
            
            // 更新 Tab 標題
            const header1 = document.getElementById('subject-entry-header');
            const header2 = document.getElementById('subject-summary-header');
            const header1_2 = document.getElementById('subject-entry-header-2');
            const header2_2 = document.getElementById('subject-summary-header-2');
            
            if (subjectKey === 'chinese') {
                header1.textContent = '國文 分數';
                header2.textContent = '國文 分數';
                header1_2.textContent = '作文 分數';
                header2_2.textContent = '作文 分數';
                header1_2.classList.remove('hidden');
                header2_2.classList.remove('hidden');
            } else {
                header1.textContent = `${subjectName} 分數`;
                header2.textContent = `${subjectName} 分數`;
                header1_2.classList.add('hidden');
                header2_2.classList.add('hidden');
            }
            
            await loadSubjectGradeEntryTab();
            setupSubjectTeacherTabs();
        }
        
        function setupSubjectTeacherTabs() {
            const tabs = document.querySelectorAll('.subject-teacher-tab');
            const panels = document.querySelectorAll('.subject-teacher-tab-panel');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', async () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    panels.forEach(p => p.classList.add('hidden'));
                    const targetTab = tab.getAttribute('data-tab');
                    document.getElementById(targetTab).classList.remove('hidden');

                    if (targetTab === 'tab-subject-grade-entry') {
                        await loadSubjectGradeEntryTab();
                    } else if (targetTab === 'tab-subject-class-summary') {
                        await loadSubjectClassSummaryTab();
                    }
                });
            });
            
            document.getElementById('exam-select-subject-entry').addEventListener('change', loadSubjectGradeEntryTab);
            document.getElementById('exam-select-subject-summary').addEventListener('change', loadSubjectClassSummaryTab);
        }

        // Tab 1: 單科成績登錄 (專科教師)
        async function loadSubjectGradeEntryTab() {
            const selectedExam = document.getElementById('exam-select-subject-entry').value;
            const tableBody = document.getElementById('subject-grade-entry-table-body');
            tableBody.innerHTML = '';
            const subjectKey = currentUser.subject;
            
            showLoading(true);
            try {
                const students = await getAllStudents(); // 已依座號排序
                const gradesMap = await getGradesForExam(selectedExam);
                
                students.forEach(student => {
                    const grade = gradesMap.get(student.name) || {};
                    const score = grade[subjectKey] || '--';
                    
                    const tr = document.createElement('tr');
                    
                    if (subjectKey === 'chinese') {
                        const scoreComposition = grade.composition || '--';
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${student.seatNumber || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${score === '--' ? 'text-gray-500' : 'text-gray-900'}">${score}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${scoreComposition === '--' ? 'text-gray-500' : 'text-gray-900'}">${scoreComposition}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="edit-subject-grade-btn text-blue-600 hover:text-blue-900" data-student-name="${student.name}">編輯</button>
                            </td>
                        `;
                    } else {
                         tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${student.seatNumber || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${score === '--' ? 'text-gray-500' : 'text-gray-900'}">${score}</td>
                            <td class="hidden"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="edit-subject-grade-btn text-blue-600 hover:text-blue-900" data-student-name="${student.name}">編輯</button>
                            </td>
                        `;
                    }
                    tableBody.appendChild(tr);
                });
                
                // 綁定編輯按鈕
                document.querySelectorAll('.edit-subject-grade-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const studentName = btn.getAttribute('data-student-name');
                        const grade = gradesMap.get(studentName) || {};
                        openEditSubjectGradeModal(studentName, selectedExam, grade);
                    });
                });
                
            } catch (error) {
                console.error("載入單科成績登錄失敗:", error);
            } finally {
                showLoading(false);
            }
        }
        
        // 開啟單科成績編輯 Modal (專科教師)
        function openEditSubjectGradeModal(studentName, exam, grade) {
            const subjectKey = currentUser.subject;
            const subjectName = subjectNames[subjectKey] || subjectKey;
            
            document.getElementById('modal-subject-student-name').textContent = studentName;
            document.getElementById('modal-subject-exam-name').textContent = exam;
            document.getElementById('modal-subject-student-id').value = studentName;
            document.getElementById('modal-subject-exam-id').value = exam;

            const mainField = document.getElementById('modal-subject-field');
            const compField = document.getElementById('modal-composition-field');
            const mainLabel = document.getElementById('modal-subject-label');
            const mainInput = document.getElementById('modal-subject-score-main');
            const compInput = document.getElementById('modal-subject-score-composition');
            
            if (subjectKey === 'chinese') {
                mainField.classList.remove('hidden');
                compField.classList.remove('hidden');
                mainLabel.textContent = '國文 分數';
                mainInput.value = grade.chinese || '';
                compInput.value = grade.composition || '';
            } else {
                mainField.classList.remove('hidden');
                compField.classList.add('hidden');
                mainLabel.textContent = `${subjectName} 分數`;
                mainInput.value = grade[subjectKey] || '';
                compInput.value = ''; // 清空
            }
            
            editSubjectGradeModal.classList.remove('hidden');
        }

        // 儲存單科成績 (專科教師)
        document.getElementById('edit-subject-grade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentName = document.getElementById('modal-subject-student-id').value;
            const exam = document.getElementById('modal-subject-exam-id').value;
            const subjectKey = currentUser.subject;
            
            showLoading(true);
            try {
                const docId = `${studentName}_${exam}`;
                // *** 路徑簡化 ***
                const docRef = doc(db, "grades", docId);
                const docSnap = await getDoc(docRef);
                
                let scores = {};
                if (docSnap.exists()) {
                    scores = docSnap.data();
                } else {
                    scores = { studentName, exam };
                }
                
                // 更新該科分數
                if (subjectKey === 'chinese') {
                    const newScoreChinese = parseFloat(document.getElementById('modal-subject-score-main').value) || 0;
                    const newScoreComposition = parseFloat(document.getElementById('modal-subject-score-composition').value) || 0;
                    scores['chinese'] = newScoreChinese;
                    scores['composition'] = newScoreComposition;
                } else {
                    const newScore = parseFloat(document.getElementById('modal-subject-score-main').value) || 0;
                    scores[subjectKey] = newScore;
                }
                
                // 重新計算加權平均
                scores.weightedAvg = calculateWeightedAverage(scores);
                
                // 寫回資料庫 (用 set + merge)
                await setDoc(docRef, scores, { merge: true });
                
                editSubjectGradeModal.classList.add('hidden');
                await loadSubjectGradeEntryTab(); // 重新載入
                
            } catch (error) {
                console.error("儲存單科成績失敗:", error);
                showAlert("系統錯誤", `儲存單科成績失敗：${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // Tab 2: 單科成績總覽 (專科教師)
        async function loadSubjectClassSummaryTab() {
            const selectedExam = document.getElementById('exam-select-subject-summary').value;
            const tableBody = document.getElementById('subject-class-summary-table-body');
            tableBody.innerHTML = '';
            const subjectKey = currentUser.subject;
            
            showLoading(true);
            try {
                const students = await getAllStudents();
                const gradesMap = await getGradesForExam(selectedExam);
                
                // 合併資料
                const mergedData = students.map(student => {
                    const grade = gradesMap.get(student.name) || {};
                    return {
                        ...student,
                        ...grade,
                        studentName: student.name
                    };
                });
                
                // 預設用該科成績排序
                mergedData.sort((a, b) => (b[subjectKey] || 0) - (a[subjectKey] || 0));
                allGrades = mergedData; // 緩存
                
                renderSubjectClassSummaryTable(mergedData);
                
            } catch (error) {
                console.error("載入單科總覽失敗:", error);
            } finally {
                showLoading(false);
            }
        }
        
        // 專科教師總覽的渲染函式
        function renderSubjectClassSummaryTable(grades) {
            const tableBody = document.getElementById('subject-class-summary-table-body');
            tableBody.innerHTML = '';
            const subjectKey = currentUser.subject;
            
            grades.forEach(grade => {
                const tr = document.createElement('tr');
                if (subjectKey === 'chinese') {
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${grade.seatNumber || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${grade.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.chinese || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.composition || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${parseFloat(grade.weightedAvg) >= 60 ? 'text-blue-600' : 'text-red-600'}">${grade.weightedAvg || '--'}</td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${grade.seatNumber || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${grade.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade[subjectKey] || '--'}</td>
                        <td class="hidden"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${parseFloat(grade.weightedAvg) >= 60 ? 'text-blue-600' : 'text-red-600'}">${grade.weightedAvg || '--'}</td>
                    `;
                }
                tableBody.appendChild(tr);
            });
        }


        // --- 學生儀表板 (Student Dashboard) ---
        
        let studentAllGrades = []; // 學生自己的所有成績
        let classAllGrades = []; // 班級所有成績 (用於比較)

        async function loadStudentDashboard() {
            showLoading(true);
            try {
                // 1. 獲取該學生的所有成績
                // *** 路徑簡化 ***
                const gradesCol = collection(db, "grades");
                const qStudent = query(gradesCol, where("studentName", "==", currentUser.name));
                const studentSnapshot = await getDocs(qStudent);
                studentAllGrades = studentSnapshot.docs.map(doc => doc.data());
                
                // 2. 獲取班級所有學生的名字
                // *** 路徑簡化 ***
                const usersCol = collection(db, "users");
                const qStudents = query(usersCol, where("role", "==", "student"));
                const studentsSnapshot = await getDocs(qStudents);
                const allStudentNamesSet = new Set(studentsSnapshot.docs.map(d => d.data().name));
                
                // 3. 獲取所有成績 (用於計算班級)
                const allGradesSnapshot = await getDocs(collection(db, "grades"));
                // 過濾出所有學生的成績
                classAllGrades = allGradesSnapshot.docs.map(d => d.data()).filter(g => allStudentNamesSet.has(g.studentName));

                // 4. 設定下拉選單 (只顯示有成績的段考)
                const examSelect = document.getElementById('exam-select-student');
                examSelect.innerHTML = '';
                const exams = ['第一次段考', '第二次段考', '第三次段考'];
                let hasGrades = false;
                exams.forEach(exam => {
                    if (studentAllGrades.some(g => g.exam === exam)) {
                        const option = document.createElement('option');
                        option.value = exam;
                        option.textContent = exam;
                        examSelect.appendChild(option);
                        hasGrades = true;
                    }
                });
                
                if (!hasGrades) {
                     examSelect.innerHTML = '<option value="">無成績資料</option>';
                     showAlert("提示", "您的成績尚未登錄。");
                     showLoading(false);
                     // 顯示空白儀表板
                     document.getElementById('student-avg').textContent = '--';
                     document.getElementById('student-rank').textContent = '--';
                     document.getElementById('student-overall-avg').textContent = '--';
                     setupStudentTabs(); // 仍然設定 tab
                     return; 
                }
                
                // 預設選中最新的
                examSelect.value = exams.filter(e => studentAllGrades.some(g => g.exam === e)).pop();

                // 5. 載入儀表板
                await updateStudentDashboardView();
                
                // 6. 設定事件
                setupStudentTabs();
                examSelect.addEventListener('change', updateStudentDashboardView);
                document.getElementById('subject-select-dist').addEventListener('change', updateStudentDistChart);

            } catch (error) {
                console.error("載入學生儀表板失敗:", error);
                showAlert("系統錯誤", `載入資料失敗：${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        // 學生端：更新所有 Tab 內容
        async function updateStudentDashboardView() {
            const selectedExam = document.getElementById('exam-select-student').value;
            if (!selectedExam) return;

            const currentGrade = studentAllGrades.find(g => g.exam === selectedExam);
            const currentExamClassGrades = classAllGrades.filter(g => g.exam === selectedExam);

            if (!currentGrade) {
                console.log("找不到該次段考成績");
                return;
            }
            
            updateStudentDashboard_Tab1(currentGrade, currentExamClassGrades);
            updateStudentDashboard_Tab2(currentGrade, currentExamClassGrades);
            
            document.getElementById('gemini-summary-content').innerHTML = '<p class="text-gray-500">請點擊按鈕以生成基於您最新段考成績的學習建議。</p>';
        }
        
        // 更新學生 Tab 1: 儀表板總覽
        function updateStudentDashboard_Tab1(currentGrade, classGrades) {
            document.getElementById('student-avg').textContent = currentGrade.weightedAvg;
            
            const sortedGrades = classGrades.filter(g => g.weightedAvg !== undefined).sort((a, b) => b.weightedAvg - a.weightedAvg);
            const rank = sortedGrades.findIndex(g => g.studentName === currentUser.name) + 1;
            document.getElementById('student-rank').textContent = rank > 0 ? `${rank} / ${sortedGrades.length}` : 'N/A';
            
            const totalAvg = studentAllGrades.reduce((acc, g) => acc + parseFloat(g.weightedAvg), 0) / studentAllGrades.length;
            document.getElementById('student-overall-avg').textContent = isNaN(totalAvg) ? '--' : totalAvg.toFixed(2);
            
            const classAvg = { chinese: 0, math: 0, english: 0, science: 0, social: 0 };
            const validCounts = { chinese: 0, math: 0, english: 0, science: 0, social: 0 };
            
            for (const grade of classGrades) {
                 for (const subject of subjects) {
                    if (grade[subject] !== undefined) {
                        classAvg[subject] += (grade[subject] || 0);
                        validCounts[subject]++;
                    }
                 }
            }

            for (const subject of subjects) {
                classAvg[subject] = (validCounts[subject] > 0) ? (classAvg[subject] / validCounts[subject]) : 0;
            }
            
            const radarLabels = subjects.map(s => subjectNames[s]);
            const myData = subjects.map(s => currentGrade[s] || 0);
            const classData = subjects.map(s => classAvg[s].toFixed(1));
            
            renderRadarChart(radarLabels, myData, classData);
        }
        
        // 繪製雷達圖
        function renderRadarChart(labels, myData, classData) {
            const ctx = document.getElementById('radar-chart').getContext('2d');
            if (radarChartInstance) radarChartInstance.destroy();
            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '我的分數',
                        data: myData,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgb(59, 130, 246)',
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff'
                    }, {
                        label: '班級平均',
                        data: classData,
                        fill: true,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgb(255, 99, 132)',
                        pointBackgroundColor: 'rgb(255, 99, 132)',
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    scales: { r: { suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 14, weight: 'bold' } } } },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }
        
        // 更新學生 Tab 2: 科目分析
        function updateStudentDashboard_Tab2(currentGrade, classGrades) {
            const tableBody = document.getElementById('subject-rank-table');
            tableBody.innerHTML = '';
            const allSubjectsForRank = [...subjects, 'composition', 'weightedAvg'];
            
            allSubjectsForRank.forEach(subjectKey => {
                if (!subjectNames[subjectKey]) return;
                
                const sorted = [...classGrades].filter(g => g[subjectKey] !== undefined).sort((a, b) => (b[subjectKey] || 0) - (a[subjectKey] || 0));
                const rank = sorted.findIndex(g => g.studentName === currentUser.name) + 1;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${subjectNames[subjectKey]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${currentGrade[subjectKey] || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rank > 0 ? `${rank} / ${sorted.length}` : 'N/A'}</td>
                `;
                tableBody.appendChild(tr);
            });
            
            updateStudentDistChart();
        }
        
        // 更新級距分佈圖
        function updateStudentDistChart() {
            const selectedExam = document.getElementById('exam-select-student').value;
            const classGrades = classAllGrades.filter(g => g.exam === selectedExam);
            const subjectKey = document.getElementById('subject-select-dist').value;
            
            const ranges = [0, 0, 0, 0, 0, 0];
            const labels = ['< 60', '60-69', '70-79', '80-89', '90-99', '100'];
            
            classGrades.forEach(g => {
                const score = g[subjectKey] || 0;
                if (score === 100) ranges[5]++;
                else if (score >= 90) ranges[4]++;
                else if (score >= 80) ranges[3]++;
                else if (score >= 70) ranges[2]++;
                else if (score >= 60) ranges[1]++;
                else ranges[0]++;
            });
            
            const ctx = document.getElementById('dist-chart').getContext('2d');
            if (distChartInstance) distChartInstance.destroy();
            distChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '人數',
                        data: ranges,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // 學生端 Tab 切換
        function setupStudentTabs() {
            const tabs = document.querySelectorAll('.student-tab');
            const panels = document.querySelectorAll('.student-tab-panel');

            tabs.forEach(tab => {
                tab.addEventListener('click', async () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    panels.forEach(p => p.classList.add('hidden'));
                    document.getElementById(tab.getAttribute('data-tab')).classList.remove('hidden');
                });
            });
            
            document.getElementById('get-gemini-summary-btn').addEventListener('click', loadGeminiSummary);
        }

        // --- Gemini API (AI 總結) ---
        async function loadGeminiSummary() {
            // 檢查硬編碼的 Key
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                showAlert("設定錯誤", "未找到 Gemini API Key。請在 HTML 檔案的 <script> 標籤中填入您的 API Key。");
                return;
            }
            
            const selectedExam = document.getElementById('exam-select-student').value;
            const currentGrade = studentAllGrades.find(g => g.exam === selectedExam);
            
            if (!currentGrade) {
                showAlert("錯誤", "找不到當前成績。");
                return;
            }
            
            const loadingEl = document.getElementById('gemini-loading');
            const contentEl = document.getElementById('gemini-summary-content');
            loadingEl.classList.remove('hidden');
            contentEl.innerHTML = '';
            
            const systemPrompt = "你是一位專業且友善的學習輔導老師。請根據學生提供的段考成績（滿分100），用繁體中文提供一段簡短（約3-4句話）、溫和且具體的學習建議。請著重分析強項和弱項，並提供 1-2 個可執行的建議。";
            const userQuery = `
                這是我${selectedExam}的成績：
                國文: ${currentGrade.chinese || 0} (權重x5)
                數學: ${currentGrade.math || 0} (權重x4)
                英文: ${currentGrade.english || 0} (權重x3)
                自然: ${currentGrade.science || 0} (權重x3)
                社會: ${currentGrade.social || 0} (權重x3)
                作文: ${currentGrade.composition || 0} (不計入加權)
                加權平均: ${currentGrade.weightedAvg || 0}
                
                請根據這些成績給我一些學習建議。
            `;

            const apiKey = GEMINI_API_KEY; // 使用硬編碼的 Key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                // (簡易版 exponential backoff)
                let response;
                for (let i = 0; i < 3; i++) {
                     response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    if (response.status === 429) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                    } else if (response.status === 400) {
                        throw new Error("API Key 驗證失敗，請檢查您的 Key 是否正確。");
                    } else {
                        throw new Error(`API 請求失敗: ${response.statusText}`);
                    }
                }

                if (!response.ok) {
                    throw new Error(`API 請求失敗: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    contentEl.innerHTML = text.replace(/\n/g, '<br>');
                } else {
                    throw new Error("API 回應中沒有文字。");
                }
            } catch (error) {
                console.error("Gemini API 錯誤:", error);
                contentEl.innerHTML = `<p class="text-red-600">抱歉，AI 總結目前無法使用。(${error.message})</p>`;
            } finally {
                loadingEl.classList.add('hidden');
            }
        }
        
        // --- 排序 (導師/專科教師共用) ---
        function setupTableSorting(tableSelector, dataGetter, renderer) {
             document.querySelectorAll(`${tableSelector} th[data-sort]`).forEach(th => {
                let asc = true; // 追蹤目前排序方向
                th.addEventListener('click', () => {
                    const sortKey = th.getAttribute('data-sort');
                    const data = dataGetter(); // 獲取當前緩存的數據
                    
                    // 重置其他標題的箭頭 (可選)
                    document.querySelectorAll(`${tableSelector} th[data-sort]`).forEach(h => {
                        if (h !== th) {
                            h.innerHTML = h.innerHTML.replace(/ [▲▼]$/, ''); // 移除箭頭
                        }
                    });

                    // 切換排序方向
                    const currentArrow = th.innerHTML.includes('▲') ? 'asc' : (th.innerHTML.includes('▼') ? 'desc' : '');
                    if (currentArrow === 'desc') {
                        asc = true;
                        th.innerHTML = th.innerHTML.replace(' ▼', ' ▲');
                    } else {
                        asc = false;
                        th.innerHTML = th.innerHTML.replace(' ▲', ' ▼');
                    }
                    if (currentArrow === '') {
                        asc = false; // 預設第一次點擊為降序 (分數高到低)
                        th.innerHTML += ' ▼';
                    }

                    
                    const sortedData = [...data].sort((a, b) => {
                        let valA, valB;
                        if (sortKey === 'name') {
                            valA = a.studentName || '';
                            valB = b.studentName || '';
                        } else if (sortKey === 'subjectScore') {
                            const subjectKey = currentUser.subject;
                            valA = a[subjectKey] || 0;
                            valB = b[subjectKey] || 0;
                        } else {
                            valA = a[sortKey] || 0;
                            valB = b[sortKey] || 0;
                        }

                        if (typeof valA === 'string') {
                            return asc ? valA.localeCompare(valB, 'zh-Hant') : valB.localeCompare(valA, 'zh-Hant');
                        } else {
                            // 處理 'N/A' 或 '--' (當作 0)
                            valA = parseFloat(valA) || 0;
                            valB = parseFloat(valB) || 0;
                            return asc ? valA - valB : valB - valA;
                        }
                    });
                    renderer(sortedData);
                });
            });
        }
        
        // 啟動排序
        setupTableSorting('#tab-class-summary', () => allGrades, renderClassSummaryTable);
        setupTableSorting('#tab-subject-class-summary', () => allGrades, renderSubjectClassSummaryTable);

    </script>
</body>
</html>

